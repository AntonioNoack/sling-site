<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: JCR Installer Provider</title>
        <link rel="icon" href="/res/favicon.ico"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
    </head>    <body>
<div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                </a>
            </div>
        </div><nav class="menu">
            <ul>
                <li>
                    <strong>Documentation</strong><ul>
                        <li><a href="/documentation.html">Main</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="http://sling.apache.org/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                    </ul>
                </li><li>
                    <strong>API Docs</strong><ul>
                        <li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                    </ul>
                </li><li>
                    <strong>Support</strong><ul>
                        <li><a href="http://s.apache.org/sling.wiki">Wiki</a></li><li><a href="http://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Site Map</a></li>
                    </ul>
                </li><li>
                    <strong>Project Info</strong><ul>
                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="http://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                    </ul>
                </li><li>
                    <strong>Source</strong><ul>
                        <li><a href="https://github.com/apache/?utf8=%E2%9C%93&q=sling">GitHub</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                    </ul>
                </li><li>
                    <strong>Apache Software Foundation</strong><ul>
                        <li><a href="http://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li><li><a href="https://www.apache.org/events/current-event.html">
                                <img border="0" alt="Current ASF Events" src="https://www.apache.org/events/current-event-125x125.png" width="125"/>
                            </a></li><li><a href="http://apache.org/foundation/contributing.html">
                                <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                            </a></li>
                    </ul>
                </li>
            </ul>
        </nav>        <div class="main">
            <div class="pagenav">
<div class="breadcrumbs">
                    <a href="/">
                        Home
                    </a>&nbsp;&raquo;&nbsp;<a href="/documentation.html">
                        Documentation
                    </a>&nbsp;&raquo;&nbsp;<a href="/documentation/bundles.html">
                        Bundles
                    </a>&nbsp;&raquo;&nbsp;
                </div>                
<div class="tags">
                    <a href="/tags/installer.html" class="label">
                        installer
                    </a> 
                </div>                
                
            </div><h1 class="pagetitle">
                JCR Installer Provider
            </h1><div id="generatedToC"></div><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=pagetitle],h2,h3'}); } );</script>
<div class="row"><div class="small-12 columns"><section class="wrap"><p>The JCR installer provider scans the JCR repository for artifacts and provides them to the <a href="/documentation/bundles/osgi-installer.html">OSGI installer</a>.</p>
<h2><a href="#configuration-and-scanning" name="configuration-and-scanning">Configuration and Scanning</a></h2>
<p>The JCR installer provider can be configured with weighted paths which are scanned. By default, the installer scans in <em>/apps</em> and <em>/libs</em> where artifacts found in <em>/apps</em> get a higher priority. The installer does a deep scan and uses a regular expression to detect folders containing artifacts to be installed. By default, artifacts from within a folder named <em>install</em> are provided to the OSGi installer.</p>
<p>If such an install folder contains a binary artifact (e.g. a bundle or a config file as described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>) this is provided to the OSGi installer. </p>
<p>In addition every node of type <em>sling:OsgiConfig</em> is provided as a configuration to the installer. This has the advantage of leveraging the JCR structure better than binary files, but has the known limitations outlined in <a href="https://issues.apache.org/jira/browse/SLING-4183">SLING-4183</a> and <a href="https://issues.apache.org/jira/browse/SLING-2477">SLING-2477</a>, therefore it is recommended to stick to one of the binary formats described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>.</p>
<p>The JCR installer provider does not check or scan the artifacts itself, the detection and installation is deferred to the OSGi installer.</p>
<h3><a href="#runmode-support" name="runmode-support">Runmode Support</a></h3>
<p>The JCR installer supports run modes for installing artifacts. By default folders named <em>install</em> are checked for artifacts. If Apache Sling is started with one (or more run modes), all folders named <em>install.[RUNMODE]</em> are scanned as well. To be precise, the folder name can be followed by any number of run modes separated by comma. For example, if started with run modes <em>dev</em>, <em>a1</em>, and <em>public</em>, folders like <em>install.dev</em>, <em>install.a1</em>, <em>install.public</em> are searched as well as <em>install.dev.a1</em>, or <em>install.a1.dev</em>.</p>
<p>Artifacts from folders with a run mode get a higher priority. For example by default, an <em>install</em> folder underneath <em>/libs</em> gets the priority <em>50</em>. For each run mode in the folder name, this priority is increased by <em>1</em>, so <em>install.dev</em> has <em>51</em> and <em>install.a1.dev</em> is <em>52</em>.</p>
<h2><a href="#write-back-support" name="write-back-support">Write Back Support</a></h2>
<p>The JCR installer supports writing back of configurations which are changed by some other ways, e.g by using the Apache Felix web console. If this is a new configuration which was not originally stored in the repository, a new configuration is stored under <em>/apps/sling/install</em>. The highest search path is used together with a configurable folder (*sling/install* in this case). If a configuration is changed which already exists in the repository, then it depends where the original configuration is stored. If its under <em>/libs</em> a new configuration at the same path under <em>/apps</em> is created. Otherwise the configuration is directly modified. As JCR properties do not support all Java primitive types like Integer, the write back does not generate a node of type <em>sling:OsgiConfig</em> in the repository but a properties file as described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>.</p>
<p>Write back can be turned off by configuration.</p>
<h3><a href="#start-level-support" name="start-level-support">Start Level Support</a></h3>
<p>If the parent folder of a bundle has a name which is a number, this is used as the start level (when installing the bundle for the first time, compare with <a href="https://issues.apache.org/jira/browse/SLING-2011">SLING-2011</a>). So e.g. a bundle in the path <code>/libs/sling/install/15/somebundle.jar</code> is having the start level <strong>15</strong>. </p>
<h1><a href="#example" name="example">Example</a></h1>
<p>Here's a quick walkthrough of the JCR installer functionality.</p>
<h2><a href="#installation" name="installation">Installation</a></h2>
<p>Run the <a href="https://github.com/apache/sling-org-apache-sling-starter">Sling Starter</a>.</p>
<p>To watch the logs produced by these modules, you can filter <code>sling/logs/error.log</code> using <code>egrep &#39;jcrinstall|osgi.installer&#39;</code>.</p>
<h2><a href="#install-and-remove-a-bundle" name="install-and-remove-a-bundle">Install and remove a bundle</a></h2>
<p>We'll use the <a href="http://www.knopflerfish.org/releases/2.0.5/jars/desktop_awt/desktop_awt_all-2.0.0.jar">Knopflerfish Desktop</a> bundle for this example, it is convenient as it displays a graphical user interface when started.</p>
<p>We use <code>curl</code> to create content, to make it easy to reproduce the example by copying and pasting the <code>curl</code> commands. Any other way to create content in the repository will work, of course.</p>
<p>By default, JCRInstall picks up bundles found in folders named <em>install</em> under <code>/libs</code> and <code>/apps</code>, so we start by creating such a folder:</p>
<pre><code>curl -X MKCOL  http://admin:admin@localhost:8080/apps/jcrtest
curl -X MKCOL  http://admin:admin@localhost:8080/apps/jcrtest/install
</code></pre>
<p>And we copy the bundle to install in that folder (a backslash in command lines means <em>continued on next line</em>):</p>
<pre><code>curl -T desktop_awt_all-2.0.0.jar \
  http://admin:admin@localhost:8080/apps/jcrtest/install/desktop_awt_all-2.0.0.jar
</code></pre>
<p>That's it. After 2-3 seconds, the bundle should be picked up by JCRInstall, installed and started. If this works you'll see a small <em>Knopflerfish Desktop</em> window on your desktop, and Sling's OSGi console can of course be used to check the details.</p>
<p>Removing the bundle from the repository will cause it to be uninstalled, so:</p>
<pre><code>curl -X DELETE \
  http://admin:admin@localhost:8080/apps/jcrtest/install/desktop_awt_all-2.0.0.jar
</code></pre>
<p>Should cause the <em>Knopflerfish Desktop</em> window to disappear as the bundle is uninstalled.</p>
<h2><a href="#install-modify-and-remove-a-configuration" name="install-modify-and-remove-a-configuration">Install, modify and remove a configuration</a></h2>
<p>JCRInstall installs OSGi configurations from nodes having the <em>sling:OsgiConfig</em> node type, found in folders named <em>install</em> under the installation roots (/apps and /libs).</p>
<p>Let's try this feature by creating a configuration with two properties:</p>
<pre><code>curl \
  -F &quot;jcr:primaryType=sling:OsgiConfig&quot; \
  -F foo=bar -F works=yes \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And verify the contents of our config node:</p>
<pre><code>curl \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid.json
</code></pre>
<p>Which should display something like</p>
<pre><code>{&quot;foo&quot;:&quot;bar&quot;,
&quot;jcr:created&quot;:&quot;Wed Aug 26 2009 17:06:40GMT+0200&quot;,
&quot;jcr:primaryType&quot;:&quot;sling:OsgiConfig&quot;,&quot;works&quot;:&quot;yes&quot;}
</code></pre>
<p>At this point, JCRInstall should have picked up our new config and installed it. The logs would confirm that, but we can also use the OSGi console's config status page (http://localhost:8080/system/console/config) to check it. That page should now contain:</p>
<pre><code>PID=some.config.pid
  BundleLocation=Unbound
  _jcr_config_path=jcrinstall:/apps/jcrtest/install/some.config.pid
  foo=bars
  service.pid=some.config.pid
  works=yes
</code></pre>
<p>Indicating that the configuration has been installed.</p>
<p>Let's try modifying the configuration parameters:</p>
<pre><code>curl \
  -F works=updated -F even=more \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And check the changes in the console page:</p>
<pre><code>PID=some.config.pid
  BundleLocation=Unbound
  _jcr_config_path=jcrinstall:/apps/jcrtest/install/some.config.pid
  even=more
  foo=bars
  service.pid=some.config.pid
  works=updated
</code></pre>
<p>We can now delete the configuration node:</p>
<pre><code>curl -X DELETE \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And verify that the corresponding configuration is gone in the console page (after 1-2 seconds, like for all other JCRInstall operations).</p>
<p>A node named like <code>o.a.s.foo.bar-a</code> uses <em>o.a.s.foo.bar</em> as its factory PID creating a configuration with an automatically generated PID. The value of <em>a</em> is stored as an alias in the OSGi installer to correlate the configuration object with the repository node.</p>
<h1><a href="#automated-tests" name="automated-tests">Automated Tests</a></h1>
<p>The following modules contain lots of automated tests (under <code>src/test</code>, as usual):</p>
<ul>
  <li>OSGi installer integration tests (<a href="https://github.com/apache/sling-org-apache-sling-installer-it">org.apache.sling.installer.it</a>)</li>
  <li>JCR installer service (<a href="https://github.com/apache/sling-org-apache-sling-installer-provider-jcr">org.apache.sling.installer.providers.jcr</a>)</li>
</ul>
<p>Many of these tests are fairly readable, and can be used to find out in more detail how these modules work.</p>
<h1><a href="#project-info" name="project-info">Project Info</a></h1>
<ul>
  <li>JCR installer provider (<a href="https://github.com/apache/sling-org-apache-sling-installer-provider-jcr">org.apache.sling.installer.provider.jcr</a>)</li>
</ul></section></div></div>            
            <div class="footer">
<div class="revisionInfo">
                    Last modified by <span class="author">Robert Munteanu</span> on <span class="comment">Wed Nov 22 22:30:38 2017 +0200</span>
                </div>                <p>
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </p><p>
                    Copyright © 2007-2018 The Apache Software Foundation.
                </p>
            </div>
            
        </div>
    </body>
</html>